$schema: 'https://moonrepo.dev/schemas/project.json'

type: application
language: go

tasks:
  # go run 모드
  dev-api:
    command: air
    args:
      - -c
      - .air.api.toml
    env:
      ENVIRONMENT: local

  dev-worker:
    command: air
    args:
      - -c
      - .air.worker.toml
    env:
      ENVIRONMENT: local

  # 빌드
  build-api:
    command: go
    args:
      - build
      - -o
      - bin/api
      - ./cmd/api

  build-worker:
    command: go
    args:
      - build
      - -o
      - bin/worker
      - ./cmd/worker

  # 빌드 (legacy - use build-api instead)
  build:
    command: go
    args:
      - build
      - -o
      - ./bin/api
      - ./cmd/api
    inputs:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
    outputs:
      - "bin/api"

  # 테스트
  test:
    command: go
    args:
      - test
      - -v
      - -race
      - -coverprofile=coverage.out
      - ./...
    inputs:
      - "**/*.go"

  test-short:
    command: go
    args:
      - test
      - -v
      - -short
      - ./...
    inputs:
      - "**/*.go"

  test-coverage:
    command: bash
    args:
      - -c
      - "go test -v -race -coverprofile=coverage.out ./... && go tool cover -html=coverage.out -o coverage.html"
    deps:
      - test
    inputs:
      - "**/*.go"

  lint:
    command: golangci-lint
    args:
      - run
      - ./...
    inputs:
      - "**/*.go"

  lint-fix:
    command: golangci-lint
    args:
      - run
      - --fix
      - ./...
    inputs:
      - "**/*.go"

  # Ent generate
  generate:
    command: go
    args:
      - generate
      - ./ent
    inputs:
      - "ent/schema/**/*.go"

  # run API server
  run:
    command: go
    args:
      - run
      - ./cmd/api
    local: true

  # run Worker
  run-worker:
    command: go
    args:
      - run
      - ./cmd/worker
    local: true

  # DB 마이그레이션
  migrate:
    command: atlas
    args:
      - migrate
      - apply
      - --env
      - local

  migrate-diff:
    command: atlas
    args:
      - migrate
      - diff
      - --env
      - local
    local: true

  migrate-status:
    command: atlas
    args:
      - migrate
      - status
      - --env
      - local
    local: true

  # OpenAPI 코드 생성
  generate-api:
    command: oapi-codegen
    args:
      - -config
      - oapi-codegen.yaml
      - ../../packages/protocol/tsp-output/openapi/openapi.yaml
    local: true

  # 클린업
  clean:
    command: rm
    args:
      - -rf
      - bin/
      - coverage.out
      - coverage.html
